<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company.name }} - Stock Data (Delta Mode)</title>

    <link rel="stylesheet" href="/static/style.css">

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>

<div class="container">

    
    <div class="header">
        <a href="/" class="back-link">← Back to Dashboard</a>
        <h1>{{ company.name }} (Delta Mode)</h1>
        <p>{{ company.symbol }} • {{ company.yahoo_ticker }}</p>
        <p>Total Records: <strong>{{ total_records }}</strong></p>
    </div>

    
    <div class="actions">
        <button class="btn btn-info" onclick="updateData(event)">Update Latest (Delta)</button>
        <button class="btn btn-primary" onclick="fetchFull(event)">Fetch Full History</button>
    </div>

    <div id="message"></div>

    
    <div class="content">
        <h2 style="margin: 30px 0 15px; color: #1e3c72;">Price Chart</h2>
        <div id="chart" style="width:100%; height:420px;"></div>
    </div>

    
    <div class="content">
        <h2 style="margin: 30px 0 20px; color: #1e3c72;">
            Recent Historical Data (Last 100 Records)
        </h2>

        {% if data %}
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Open</th>
                    <th>High</th>
                    <th>Low</th>
                    <th>Close</th>
                    <th>Volume</th>
                </tr>
                </thead>
                <tbody>
                {% for record in data %}
                <tr>
                    <td>{{ record.date }}</td>
                    <td>{{ "%.2f"|format(record.open) }}</td>
                    <td>{{ "%.2f"|format(record.high) }}</td>
                    <td>{{ "%.2f"|format(record.low) }}</td>
                    <td>{{ "%.2f"|format(record.close) }}</td>
                    <td>{{ "{:,.0f}".format(record.volume) }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="message info">
            <p>No data available. Click “Fetch Full History” to download records.</p>
        </div>
        {% endif %}
    </div>
</div>


<script>

function showMessage(text, type = 'info') {
    const el = document.getElementById('message');
    el.innerHTML = `<div class="message ${type}">${text}</div>`;
    setTimeout(() => el.innerHTML = '', 5000);
}


async function updateData(event) {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = 'Updating...';

    const res = await fetch('/api/update-company/{{ company.symbol }}', { method: 'POST' });
    const data = await res.json();

    showMessage(`Fetched ${data.fetched}, inserted ${data.inserted}`, 'success');
    setTimeout(() => location.reload(), 1200);
}


async function fetchFull(event) {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = 'Fetching...';

    const res = await fetch('/api/fetch-company/{{ company.symbol }}', { method: 'POST' });
    const data = await res.json();

    showMessage(`Fetched ${data.fetched}, inserted ${data.inserted}`, 'success');
    setTimeout(() => location.reload(), 1200);
}


document.addEventListener("DOMContentLoaded", function () {

    const container = document.getElementById("chart");

    const chart = LightweightCharts.createChart(container, {
        width: container.offsetWidth || 900,
        height: 420,
        layout: {
            background: { color: "#ffffff" },
            textColor: "#000000",
        },
        grid: {
            vertLines: { color: "#eeeeee" },
            horzLines: { color: "#eeeeee" },
        },
        timeScale: {
            timeVisible: true,
            secondsVisible: false,
        },
    });

    const candleSeries = chart.addSeries(
        LightweightCharts.CandlestickSeries,
        {
            upColor: "#26a69a",
            downColor: "#ef5350",
            borderUpColor: "#26a69a",
            borderDownColor: "#ef5350",
            wickUpColor: "#26a69a",
            wickDownColor: "#ef5350",
        }
    );

    fetch(`/api/company/{{ company.symbol }}/history`)
        .then(res => res.json())
        .then(data => {
            console.log("COMPANY CHART DATA:", data);

            if (!data || data.length === 0) return;

            candleSeries.setData(
                data.map(d => ({
                    time: d.date,     
                    open: Number(d.open),
                    high: Number(d.high),
                    low: Number(d.low),
                    close: Number(d.close)
                }))
            );

            chart.timeScale().fitContent();
        });

    window.addEventListener("resize", () => {
        chart.applyOptions({ width: container.offsetWidth || 900 });
    });
});
</script>

</body>
</html>
