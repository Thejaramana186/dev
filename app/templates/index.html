<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nifty 50 Stock Data Fetcher</title>

    <link rel="stylesheet" href="/static/style.css">

    <style>
        .chart-container {
            width: 100%;
            margin: 25px 0;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            padding: 10px;
        }

        #niftyChart {
            width: 100%;
            height: 500px;
        }
    </style>
</head>

<body>
<div class="container">

    
    <div class="header">
        <h1>Nifty 50 Stock Data Fetcher</h1>
        <p>Live & historical OHLC data from Yahoo Finance</p>
    </div>

    
    <h2 style="color:#1e3c72; margin-top: 20px;">
        Market Overview (NIFTY 50)
    </h2>

    
    <div class="chart-container">
        <div id="niftyChart"></div>
    </div>

    
    <div class="actions">
        <button class="btn btn-primary" onclick="loadCompanies(event)">
            Load Companies
        </button>

        <button class="btn btn-secondary" onclick="fetchAll(event)">
            Fetch All Historical Data
        </button>

        <a href="/custom-fetch" class="btn btn-info">
            Custom Stock Fetcher
        </a>
    </div>

    <div class="content">
        <div id="message"></div>

        
        <div class="stats">
            <div class="stat-card">
                <h3>Total Companies</h3>
                <p>{{ companies|length }}</p>
            </div>

            <div class="stat-card">
                <h3>Companies with Data</h3>
                <p>{{ companies|selectattr('count', 'gt', 0)|list|length }}</p>
            </div>

            <div class="stat-card">
                <h3>Total Data Points</h3>
                <p>{{ companies|sum(attribute='count') }}</p>
            </div>
        </div>

        
        <h2 style="margin-bottom: 20px; color: #1e3c72;">
            Companies
        </h2>

        <div class="companies-grid">
            {% for item in companies %}
            <div class="company-card">
                <h3>{{ item.company.name }}</h3>
                <div class="symbol">{{ item.company.symbol }}</div>

                <div class="info">
                    <span><strong>Ticker:</strong> {{ item.company.yahoo_ticker }}</span>
                    <span><strong>Records:</strong> {{ item.count }}</span>
                    {% if item.latest_date %}
                        <span><strong>Latest:</strong> {{ item.latest_date }}</span>
                    {% endif %}
                </div>

                <div class="actions">
                    <a href="/company/{{ item.company.symbol }}" class="btn btn-info">
                        View Data
                    </a>

                    <button class="btn btn-info"
                            onclick="fetchCompany('{{ item.company.symbol }}', event)">
                        {% if item.count > 0 %}Update{% else %}Fetch{% endif %}
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>


<script>
function showMessage(text, type = 'info') {
    const el = document.getElementById('message');
    el.innerHTML = `<div class="message ${type}">${text}</div>`;
    setTimeout(() => el.innerHTML = '', 5000);
}

async function loadCompanies(event) {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = 'Loading...';

    const res = await fetch('/api/load-companies', { method: 'POST' });
    const data = await res.json();

    showMessage(`Loaded ${data.loaded} companies`, 'success');
    setTimeout(() => location.reload(), 1200);
}

async function fetchAll(event) {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = 'Fetching...';

    const res = await fetch('/api/fetch-all', { method: 'POST' });
    const data = await res.json();

    showMessage(data.message + " (running in background)", 'info');
}

async function fetchCompany(symbol, event) {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = 'Fetching...';

    const res = await fetch(`/api/fetch-company/${symbol}`, { method: 'POST' });
    const data = await res.json();

    showMessage(`Inserted ${data.inserted} records for ${symbol}`, 'success');
    setTimeout(() => location.reload(), 1200);
}
</script>

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const container = document.getElementById("niftyChart");

    const chart = LightweightCharts.createChart(container, {
        width: container.offsetWidth || 900,
        height: 500,
        layout: {
            background: { color: "#ffffff" },
            textColor: "#000000",
        },
        grid: {
            vertLines: { color: "#eeeeee" },
            horzLines: { color: "#eeeeee" },
        },
        timeScale: {
    timeVisible: true,
    secondsVisible: false,
},

    });

    const candleSeries = chart.addSeries(
    LightweightCharts.CandlestickSeries,
    {
        upColor: "#26a69a",
        downColor: "#ef5350",
        borderUpColor: "#26a69a",
        borderDownColor: "#ef5350",
        wickUpColor: "#26a69a",
        wickDownColor: "#ef5350",
    }
);


    fetch("/api/nifty")
        .then(res => res.json())
        .then(data => {
            console.log("NIFTY DATA:", data);

            if (!data || data.length === 0) {
                console.error("No data received");
                return;
            }

            candleSeries.setData(data);
            chart.timeScale().fitContent();
        })
        .catch(err => console.error("Chart error:", err));

    window.addEventListener("resize", () => {
        chart.applyOptions({
            width: container.offsetWidth || 900
        });
    });

});
</script>

</body>
</html>
